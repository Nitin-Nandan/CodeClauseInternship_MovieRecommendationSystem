{% extends 'movapp/base.html' %}

{% block title %}Movie Recommendations - Find Your Next Favorite Film{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Left Panel: Filters and Controls -->
    <div class="filters-panel">
        <h3 class="panel-header">üéõÔ∏è Search Filters</h3>
        
        <!-- Genre Filter -->
        <div class="filter-group">
            <label class="filter-label">Genres</label>
            <div class="genre-checkboxes" id="genre-checkboxes">
                <div class="genre-checkbox">
                    <input type="checkbox" id="action" value="Action">
                    <label for="action">Action</label>
                </div>
                <div class="genre-checkbox">
                    <input type="checkbox" id="comedy" value="Comedy">
                    <label for="comedy">Comedy</label>
                </div>
                <div class="genre-checkbox">
                    <input type="checkbox" id="drama" value="Drama">
                    <label for="drama">Drama</label>
                </div>
                <div class="genre-checkbox">
                    <input type="checkbox" id="horror" value="Horror">
                    <label for="horror">Horror</label>
                </div>
                <div class="genre-checkbox">
                    <input type="checkbox" id="romance" value="Romance">
                    <label for="romance">Romance</label>
                </div>
                <div class="genre-checkbox">
                    <input type="checkbox" id="sci-fi" value="Sci-Fi">
                    <label for="sci-fi">Sci-Fi</label>
                </div>
                <div class="genre-checkbox">
                    <input type="checkbox" id="thriller" value="Thriller">
                    <label for="thriller">Thriller</label>
                </div>
                <div class="genre-checkbox">
                    <input type="checkbox" id="fantasy" value="Fantasy">
                    <label for="fantasy">Fantasy</label>
                </div>
            </div>
        </div>

        <!-- Year Range Filter -->
        <div class="filter-group">
            <label class="filter-label">Release Year</label>
            <div class="range-slider">
                <input type="range" class="range-input" id="year-min" min="1900" max="2024" value="1990">
                <input type="range" class="range-input" id="year-max" min="1900" max="2024" value="2024">
                <div class="range-values">
                    <span id="year-min-value">1990</span>
                    <span id="year-max-value">2024</span>
                </div>
            </div>
        </div>

        <!-- Rating Filter -->
        <div class="filter-group">
            <label class="filter-label">Minimum Rating</label>
            <select class="filter-input" id="rating-filter">
                <option value="0">Any Rating</option>
                <option value="3">3+ Stars</option>
                <option value="4">4+ Stars</option>
                <option value="4.5">4.5+ Stars</option>
            </select>
        </div>

        <!-- Sort Options -->
        <div class="filter-group">
            <label class="filter-label">Sort By</label>
            <select class="filter-input" id="sort-filter">
                <option value="rating">Highest Rated</option>
                <option value="year">Newest First</option>
                <option value="popularity">Most Popular</option>
                <option value="alphabetical">A-Z</option>
            </select>
        </div>

        <!-- Clear Filters Button -->
        <button type="button" class="btn-recommend" id="clear-filters" style="background: var(--text-muted); margin-top: 20px; font-size: 14px; padding: 10px 20px;">
            üîÑ Clear Filters
        </button>
    </div>

    <!-- Center Panel: Main Content -->
    <div class="main-content">
        <div class="main-header">
            <h1 class="main-title">üé¨ Movie Recommender</h1>
            <p class="main-subtitle">Tell us your favorite movies, and we'll find your next obsession!</p>
        </div>

        {% if error %}
            <div style="background: #ff6b6b; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                {{ error }}
            </div>
        {% endif %}
        
        <form method="post" id="recommendation-form">
            {% csrf_token %}
            
            <div class="search-container">
                <input 
                    type="text" 
                    class="search-box" 
                    id="movie-search" 
                    placeholder="üîç Search for movies you love..." 
                    autocomplete="off"
                >
                <div id="search-results" style="display: none;"></div>
            </div>
            
            <div class="selected-movies" id="selected-movies">
                <p style="color: var(--text-muted);">Selected movies will appear here...</p>
            </div>
            
            <!-- Hidden inputs for selected movies -->
            <div id="hidden-inputs"></div>
            
            <button type="submit" class="btn-recommend" id="recommend-btn" disabled>
                ‚ú® Get My Recommendations
            </button>
            
            <p class="instructions">
                üí° Select at least 3 movies to get personalized recommendations
            </p>
        </form>
    </div>

    <!-- Right Panel: Compact Live Preview -->
    <div class="preview-panel">
        <h3 class="panel-header">üîÆ Preview</h3>
        
        <div id="user-profile" style="margin-bottom: 20px;">
            <h4 style="color: var(--text-secondary); margin-bottom: 10px; font-size: 14px;">Your Taste</h4>
            <div id="preferred-genres" style="font-size: 11px; color: var(--text-muted); line-height: 1.4;">
                Select movies to see preferences
            </div>
        </div>

        <div id="quick-recommendations">
            <h4 style="color: var(--text-secondary); margin-bottom: 15px; font-size: 14px;">Popular Movies</h4>
            <div class="preview-item" style="padding: 10px; margin-bottom: 10px;">
                <div class="preview-title" style="font-size: 12px;">The Shawshank Redemption</div>
                <div class="preview-meta" style="font-size: 10px;">Drama ‚Ä¢ 1994 ‚Ä¢ ‚≠ê 9.3</div>
            </div>
            <div class="preview-item" style="padding: 10px; margin-bottom: 10px;">
                <div class="preview-title" style="font-size: 12px;">The Dark Knight</div>
                <div class="preview-meta" style="font-size: 10px;">Action ‚Ä¢ 2008 ‚Ä¢ ‚≠ê 9.0</div>
            </div>
            <div class="preview-item" style="padding: 10px; margin-bottom: 10px;">
                <div class="preview-title" style="font-size: 12px;">Pulp Fiction</div>
                <div class="preview-meta" style="font-size: 10px;">Crime ‚Ä¢ 1994 ‚Ä¢ ‚≠ê 8.9</div>
            </div>
        </div>
    </div>
</div>

<script>
    // Same JavaScript as before but with improved spacing
    const searchBox = document.getElementById('movie-search');
    const searchResults = document.getElementById('search-results');
    const selectedMoviesDiv = document.getElementById('selected-movies');
    const hiddenInputsDiv = document.getElementById('hidden-inputs');
    const recommendBtn = document.getElementById('recommend-btn');
    const preferredGenresDiv = document.getElementById('preferred-genres');
    let selectedMovies = [];
    let searchTimeout;

    // Real-time movie search with filtering
    searchBox.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            searchResults.style.display = 'none';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/search/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displaySearchResults(data.movies);
                })
                .catch(error => {
                    console.error('Search error:', error);
                });
        }, 300);
    });

    function displaySearchResults(movies) {
        if (movies.length === 0) {
            searchResults.style.display = 'none';
            return;
        }
        
        searchResults.innerHTML = movies.map(movie => 
            `<div onclick="selectMovie('${movie.replace(/'/g, "\\'")}')">${movie}</div>`
        ).join('');
        
        searchResults.style.display = 'block';
    }

    function selectMovie(title) {
        if (!selectedMovies.includes(title)) {
            selectedMovies.push(title);
            updateSelectedMovies();
            updateRecommendButton();
            updateHiddenInputs();
            updateUserProfile();
        }
        
        searchBox.value = '';
        searchResults.style.display = 'none';
    }

    function removeMovie(title) {
        selectedMovies = selectedMovies.filter(movie => movie !== title);
        updateSelectedMovies();
        updateRecommendButton();
        updateHiddenInputs();
        updateUserProfile();
    }

    function updateSelectedMovies() {
        if (selectedMovies.length === 0) {
            selectedMoviesDiv.innerHTML = '<p style="color: var(--text-muted);">Selected movies will appear here...</p>';
            selectedMoviesDiv.classList.remove('has-movies');
        } else {
            selectedMoviesDiv.classList.add('has-movies');
            selectedMoviesDiv.innerHTML = selectedMovies.map(movie => 
                `<span class="movie-tag">
                    ${movie}
                    <span class="remove" onclick="removeMovie('${movie.replace(/'/g, "\\'")}')">&times;</span>
                </span>`
            ).join('');
        }
    }

    function updateRecommendButton() {
        recommendBtn.disabled = selectedMovies.length < 3;
    }

    function updateHiddenInputs() {
        hiddenInputsDiv.innerHTML = selectedMovies.map(movie => 
            `<input type="hidden" name="selected_movies" value="${movie}">`
        ).join('');
    }

    function updateUserProfile() {
        if (selectedMovies.length === 0) {
            preferredGenresDiv.textContent = 'Select movies to see preferences';
            return;
        }

        // Extract genres from selected movies (simplified)
        const genres = new Set();
        selectedMovies.forEach(movie => {
            if (movie.toLowerCase().includes('horror')) genres.add('Horror');
            if (movie.toLowerCase().includes('comedy')) genres.add('Comedy');
            if (movie.toLowerCase().includes('action')) genres.add('Action');
            if (movie.toLowerCase().includes('romance')) genres.add('Romance');
        });

        if (genres.size > 0) {
            preferredGenresDiv.innerHTML = Array.from(genres).map(genre => 
                `<span style="background: var(--accent-primary); color: white; padding: 1px 6px; border-radius: 8px; margin: 1px; display: inline-block; font-size: 9px;">${genre}</span>`
            ).join('');
        } else {
            preferredGenresDiv.textContent = 'Analyzing preferences...';
        }
    }

    // Filter functionality (same as before)
    const yearMinSlider = document.getElementById('year-min');
    const yearMaxSlider = document.getElementById('year-max');
    const yearMinValue = document.getElementById('year-min-value');
    const yearMaxValue = document.getElementById('year-max-value');

    yearMinSlider.addEventListener('input', function() {
        yearMinValue.textContent = this.value;
        if (parseInt(this.value) > parseInt(yearMaxSlider.value)) {
            yearMaxSlider.value = this.value;
            yearMaxValue.textContent = this.value;
        }
    });

    yearMaxSlider.addEventListener('input', function() {
        yearMaxValue.textContent = this.value;
        if (parseInt(this.value) < parseInt(yearMinSlider.value)) {
            yearMinSlider.value = this.value;
            yearMinValue.textContent = this.value;
        }
    });

    document.getElementById('clear-filters').addEventListener('click', function() {
        document.querySelectorAll('.genre-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
        yearMinSlider.value = 1990;
        yearMaxSlider.value = 2024;
        yearMinValue.textContent = '1990';
        yearMaxValue.textContent = '2024';
        document.getElementById('rating-filter').value = '0';
        document.getElementById('sort-filter').value = 'rating';
    });

    document.addEventListener('click', function(e) {
        if (!searchBox.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });
</script>
{% endblock %}
